<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Jungle Monkey</title>
    
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #0d0d1a;
            overflow: hidden; 
            user-select: none;
        }

        #game-board {
            width: 350px; 
            height: 600px;
            background-color: #000000;
            border: 3px solid blue; /* Theme Color */
            position: relative; 
            overflow: hidden;
            touch-action: none; 
            z-index: 1; 
        }

        /* PLAYER STYLE (Monkey Emoji) */
        #player {
            width: 40px;
            height: 40px;
            background: none; 
            font-size: 38px;
            text-align: center;
            line-height: 40px;
            position: absolute;
            bottom: 10px; 
            left: 155px; 
            border-radius: 5px;
            user-select: none;
            cursor: grab; 
        }

        /* Score Display (FIXED POSITION) */
        #score {
            position: absolute;
            top: 5px; 
            left: 130px; /* Moved slightly left */
            transform: none; 
            color: #FFD700; 
            font-size: 1.2em;
            z-index: 10; 
            font-family: sans-serif;
            white-space: nowrap;
        }
        
        #high-score {
            position: absolute;
            top: 5px; 
            right: 5px; 
            color: #FFD700; 
            font-size: 1.2em;
            z-index: 10; 
            font-family: sans-serif;
            white-space: nowrap;
        }

        /* LIVES DISPLAY STYLE */
        #lives {
            position: absolute;
            top: 5px; 
            left: 5px; 
            color: #ff0000; 
            font-size: 1.2em;
            z-index: 10; 
            font-family: sans-serif;
            font-weight: bold;
        }

        .bullet {
            width: 4px;
            height: 12px;
            background-color: #FF8000; 
            position: absolute;
        }
        
        .bullet.powered-up {
            background-color: #00ff00; 
        }

        .enemy {
            width: 40px;
            height: 40px;
            background: none; 
            font-size: 36px; 
            text-align: center;
            line-height: 40px;
            position: absolute;
            border-radius: 5px;
        }
        
        /* Game Over Screen */
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: blue; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            text-align: center;
            font-family: sans-serif;
        }

        #game-over-screen h1 {
            color: #FFD700; 
        }

        #game-over-high-score {
            color: #FFAA00;
            font-size: 1.1em;
            margin-top: 10px;
            font-weight: bold;
        }

        #game-over-screen button, #settings-screen button, #settings-screen select {
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #purple; 
            border: none;
            border-radius: 5px;
            color: blue;
            transition: background-color 0.1s;
        }

        #game-over-screen button:hover, #settings-screen button:hover, #settings-screen select:hover {
             background-color: #ffaa4d;
        }
        
        /* Positioning and styling the Pause Button */
        #pause-button { 
            position: absolute;
            top: 35px; /* Moved down to avoid score */
            right: 5px; 
            padding: 5px 10px;
            font-size: 0.8em;
            z-index: 10;
            background-color: #5555ff; 
            border: 2px solid #5555ff;
            cursor: pointer;
            border-radius: 8px;
            color: white;
            font-weight: bold;
        }
        
        /* Settings Button */
        #settings-button {
            position: absolute;
            top: 35px; /* Moved down to avoid score */
            right: 80px; 
            padding: 5px 10px;
            font-size: 0.8em;
            z-index: 10;
            background-color: #888888; 
            border: 2px solid #888888;
            cursor: pointer;
            border-radius: 8px;
            color: white;
            font-weight: bold;
        }

        /* HELP SCREEN STYLES */
        #help-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 13, 26, 0.98); 
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 30; 
            text-align: center;
            font-family: sans-serif;
            overflow-y: auto; 
        }
        
        /* SETTINGS SCREEN STYLES */
        #settings-screen {
             position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 13, 26, 0.98); 
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; 
            text-align: center;
            font-family: sans-serif;
        }

        #settings-screen h2 {
            color: #FFD700;
            margin-bottom: 30px;
        }
        
        #settings-screen label {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        #control-type-select {
            padding: 8px;
            border: 2px solid #FF8000;
            background-color: #0d0d1a;
            color: white;
            border-radius: 5px;
            font-size: 1em;
        }


        .hidden {
            display: none !important;
            pointer-events: none !important; 
        }

        /* === MOBILE CONTROLS STYLES === */
        #controls {
            display: flex;
            justify-content: center; 
            align-items: center;
            width: 350px;
            margin-top: 10px;
        }

        /* General control buttons (for Button Mode) */
        #controls button {
            padding: 15px 30px; 
            font-size: 1.5em; 
            font-weight: bold;
            color: white;
            border: 2px solid blue; 
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            flex-grow: 1; 
            margin: 0 5px;
            opacity: 1; 
            transition: opacity 0.1s;
            background-color: #333; 
        }
        
        /* Specific shoot button styling */
        #shoot-button {
            background-color: #FF8000; 
            border-color: #FF8000;
            flex-grow: 1;
        }
        
        /* Styling for when button mode is active */
        .button-controls #controls button.movement-button {
             background-color: #333; 
             flex-grow: 1;
        }
        
    </style>
</head>
<body>
    <div id="game-board">
        <div id="score">Score: 0</div>
        <div id="high-score">High Score: 0</div>
        
        <div id="lives">Lives: 3</div>

        <button id="settings-button" class="hidden">‚öôÔ∏è SETTINGS</button>
        <button id="pause-button" class="hidden">PAUSE</button> 
        
        <div id="settings-screen" class="hidden">
            <h2>Game Settings</h2>
            
            <label for="control-type-select">Movement Controls:</label>
            <select id="control-type-select">
                <option value="touch">Touch/Drag</option>
                <option value="buttons">Buttons (‚óÄÔ∏è / ‚ñ∂Ô∏è)</option>
            </select>
            
            <button id="close-settings">Back to Game</button>
        </div>
        
        <div id="help-screen" class="hidden">
            <h2>How to Play The Jungle Monkey</h2>
            <p><strong>Goal:</strong> Shoot the falling enemies and get the highest score!</p>
            <p id="movement-instructions"><strong>Movement:</strong> **Touch and drag** the monkey üêµ left and right!</p>
            <p><strong>Shooting:</strong> Use the FIRE button or the SPACE bar.</p>
            
            <p>
                <strong>Dangerous Enemies (Dodge or Shoot!):</strong>
                <span class="enemy-key">ü¶Å</span> <span class="enemy-key">üêê</span> <span class="enemy-key">üêÇ</span> <span class="enemy-key">üêª</span> <span class="enemy-key">ü¶õ</span><br>
                üí• If these pass the bottom, you lose a **Life**!
            </p>
            
            <p>
                <strong>Bonus Items:</strong>
                <span class="enemy-key" style="color:#FFD700;">ü§ë</span> Get **+50** points.<br>
                <span class="enemy-key" style="color:#FFD700;">üçë</span> Get **+30** points.<br>
                <span class="enemy-key" style="color:#FF8000;">‚ö°Ô∏è</span> Activates **Triple Shot**! (You change to ü¶ç and bullets turn green).
            </p>
            
            <p>
                <strong>Negative Items (Avoid!):</strong>
                <span class="enemy-key" style="color:#ff0000;">üêµ</span> <span class="enemy-key" style="color:#ff0000;">üçå</span> Lose **-30** points.
            </p>

            <p>
    Earn free N1000:  <a href="https://info.palmpay.com/EyX19WqC">Palmpay users</a>
            </p>

                <p>
    Dev:  <a href="https://x.com/noblect1">Noble</a>
                </p>

            <button id="close-help">Got it!</button>
        </div>
        
        <div id="player">üêµ</div>
        
        <div id="game-over-screen" class="hidden">
            <h1 id="screen-title">THE JUNGLE MONKEY</h1>
            <p id="final-score" style="font-size: 1.4em;"></p>
            <p id="game-over-high-score" class="hidden"></p> <button id="restart-button">Start Game</button>
            <p style="margin-top: 20px; color: #FFD700; font-size: 0.9em;">
                <span id="open-help-link" style="cursor: pointer; text-decoration: underline; margin-right: 15px;">How to Play (Help)</span>
                <span id="open-settings-link" style="cursor: pointer; text-decoration: underline;">Settings</span>
            </p>
        </div>
    </div>
    
    <div id="controls">
        <button id="shoot-button">FIRE</button>
    </div>

    <script>
        const gameBoard = document.getElementById('game-board');
        const player = document.getElementById('player');
        const scoreDisplay = document.getElementById('score');
        const highScoreDisplay = document.getElementById('high-score');
        const livesDisplay = document.getElementById('lives');
        const gameOverScreen = document.getElementById('game-over-screen');
        const restartButton = document.getElementById('restart-button');
        const finalScoreDisplay = document.getElementById('final-score');
        const gameOverHighScore = document.getElementById('game-over-high-score');
        const helpScreen = document.getElementById('help-screen');
        const closeHelpButton = document.getElementById('close-help');
        const openHelpLink = document.getElementById('open-help-link');
        const settingsScreen = document.getElementById('settings-screen');
        const settingsButton = document.getElementById('settings-button');
        const closeSettingsButton = document.getElementById('close-settings');
        const openSettingsLink = document.getElementById('open-settings-link');
        const controlTypeSelect = document.getElementById('control-type-select');
        const movementInstructions = document.getElementById('movement-instructions');
        const controlsDiv = document.getElementById('controls');
        const shootButton = document.getElementById('shoot-button');
        const pauseButton = document.getElementById('pause-button');
        
        // Constants
        const boardWidth = 350;
        const boardHeight = 600;
        const playerWidth = 40; 
        const bulletHeight = 12;
        const enemyHeight = 40;
        const playerSpeed = 10;
        const bulletSpeed = 8;
        const HIGH_SCORE_KEY = 'jungleMonkeyHighScore'; 
        const CONTROL_TYPE_KEY = 'jungleMonkeyControlType';
        const POWERUP_DURATION = 10000; // 10 seconds

        // Game State and Variables
        let gameLoopId;
        let enemySpawnId;
        let bulletCleanupId;
        let isPaused = false;
        let gameOver = true; 
        let score = 0;
        let lives = 3;
        let highScore = 0;
        let keysPressed = {};
        let bullets = [];
        let enemies = [];
        let enemySpawnRate = 1500; // milliseconds
        let powerUpTimer = 0; // ms
        
        // Enemy Emojis 
        const enemyTypes = {
            normal: ['ü¶Å', 'üêê', 'üêÇ', 'üêª', 'ü¶õ'],
            bonus: ['üçë', 'ü§ë'],
            negative: ['üêµ', 'üçå'],
            powerup: ['‚ö°Ô∏è']
        };
        
        // --- Control State ---
        let controlType = localStorage.getItem(CONTROL_TYPE_KEY) || 'touch';
        let isDragging = false;
        let lastTouchX = 0;
        let playerX = (boardWidth / 2) - (playerWidth / 2); // Center 155

        // --- Player Movement Functions ---

        function updatePlayerPosition() {
            // Clamping position
            playerX = Math.max(0, Math.min(playerX, boardWidth - playerWidth));
            player.style.left = playerX + 'px';
        }

        function handleKeyboardMovement() {
            if (keysPressed['ArrowLeft'] || keysPressed['a']) {
                playerX -= playerSpeed;
            }
            if (keysPressed['ArrowRight'] || keysPressed['d']) {
                playerX += playerSpeed;
            }
            updatePlayerPosition();
        }
        
        // --- Shooting Logic ---
        
        function createBullet(x, y, isPoweredUp = false) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            if (isPoweredUp) {
                bullet.classList.add('powered-up');
            }
            bullet.style.left = x + 'px';
            bullet.style.top = y + 'px';
            gameBoard.appendChild(bullet);
            bullets.push({ 
                element: bullet, 
                x: x, 
                y: y, 
                isPoweredUp: isPoweredUp 
            });
        }

        function handleShooting() {
            if (isPaused || gameOver) return; 

            const center = playerX + (playerWidth / 2) - 2; 
            const top = boardHeight - playerWidth - 12; 

            if (powerUpTimer > 0) {
                // Triple Shot
                createBullet(center - 15, top, true);
                createBullet(center, top, true);
                createBullet(center + 15, top, true);
            } else {
                // Single Shot
                createBullet(center, top);
            }
        }

        // --- Control Setup and UI Logic ---

        function setupControls(type) {
            const existingButtons = controlsDiv.querySelectorAll('.movement-button');
            existingButtons.forEach(btn => btn.remove());
            
            controlsDiv.classList.remove('button-controls');
            player.style.cursor = 'grab';
            
            if (type === 'touch') {
                movementInstructions.innerHTML = '<strong>Movement:</strong> **Touch and drag** the monkey üêµ left and right!';
            } else { 
                movementInstructions.innerHTML = '<strong>Movement:</strong> Use ‚óÄÔ∏è and ‚ñ∂Ô∏è buttons or the A/D keys.';
                controlsDiv.classList.add('button-controls');
                player.style.cursor = 'default';

                const moveLeftButton = document.createElement('button');
                moveLeftButton.id = 'move-left';
                moveLeftButton.className = 'movement-button';
                moveLeftButton.textContent = '‚óÄÔ∏è';
                
                const moveRightButton = document.createElement('button');
                moveRightButton.id = 'move-right';
                moveRightButton.className = 'movement-button';
                moveRightButton.textContent = '‚ñ∂Ô∏è';
                
                controlsDiv.insertBefore(moveLeftButton, shootButton);
                controlsDiv.appendChild(moveRightButton);
                
                // Add button listeners
                moveLeftButton.addEventListener('mousedown', () => keysPressed['ArrowLeft'] = true);
                moveLeftButton.addEventListener('mouseup', () => keysPressed['ArrowLeft'] = false);
                moveLeftButton.addEventListener('touchstart', (e) => { e.preventDefault(); keysPressed['ArrowLeft'] = true; });
                moveLeftButton.addEventListener('touchend', () => keysPressed['ArrowLeft'] = false);

                moveRightButton.addEventListener('mousedown', () => keysPressed['ArrowRight'] = true);
                moveRightButton.addEventListener('mouseup', () => keysPressed['ArrowRight'] = false);
                moveRightButton.addEventListener('touchstart', (e) => { e.preventDefault(); keysPressed['ArrowRight'] = true; });
                moveRightButton.addEventListener('touchend', () => keysPressed['ArrowRight'] = false);
            }
            
            controlType = type;
            localStorage.setItem(CONTROL_TYPE_KEY, controlType);
        }
        
        // --- Game Lifecycle Functions ---

        function loadHighScore() {
            const storedScore = localStorage.getItem(HIGH_SCORE_KEY);
            if (storedScore) {
                highScore = parseInt(storedScore);
                highScoreDisplay.textContent = `High Score: ${highScore}`;
            }
        }
        
        function startGame() {
            if (!gameOver && gameLoopId) return; 

            // Clear any old loops
            cancelAnimationFrame(gameLoopId);
            clearInterval(enemySpawnId);
            clearInterval(bulletCleanupId);
            
            // Clean up previous game visuals
            bullets.forEach(b => b.element.remove());
            enemies.forEach(e => e.element.remove());
            bullets = [];
            enemies = [];
            
            // Reset state
            score = 0;
            lives = 3;
            playerX = (boardWidth / 2) - (playerWidth / 2);
            isPaused = false;
            gameOver = false;
            powerUpTimer = 0;
            player.innerHTML = 'üêµ';
            enemySpawnRate = 1500; 
            
            updateScore(0);
            updateLives(0); 
            updatePlayerPosition(); 
            
            gameOverScreen.classList.add('hidden');
            // FIX: Show controls only when game is active
            pauseButton.classList.remove('hidden');
            settingsButton.classList.remove('hidden');

            // Start loops
            gameLoopId = requestAnimationFrame(updateGame);
            enemySpawnId = setInterval(spawnEnemy, enemySpawnRate);
            bulletCleanupId = setInterval(() => {
                if (!isPaused && !gameOver) {
                    if (powerUpTimer > 0) {
                        powerUpTimer -= 1000; 
                        if (powerUpTimer <= 0) {
                            player.innerHTML = 'üêµ';
                        }
                    }
                }
            }, 1000); 
        }
        
        function endGame(isStartup = false) {
            if (!isStartup) gameOver = true;

            cancelAnimationFrame(gameLoopId);
            clearInterval(enemySpawnId);
            clearInterval(bulletCleanupId);
            gameLoopId = null;
            enemySpawnId = null;
            bulletCleanupId = null;

            if (score > highScore) {
                highScore = score;
                localStorage.setItem(HIGH_SCORE_KEY, highScore);
            }

            gameOverScreen.classList.remove('hidden');
            helpScreen.classList.add('hidden');
            settingsScreen.classList.add('hidden');
            
            // FIX: Hide controls when game is over
            pauseButton.classList.add('hidden');
            settingsButton.classList.add('hidden');

            document.getElementById('screen-title').textContent = isStartup ? 'THE JUNGLE MONKEY' : 'GAME OVER!';
            finalScoreDisplay.textContent = `FINAL SCORE: ${score}`;
            gameOverHighScore.textContent = `HIGH SCORE: ${highScore}`;
            
            restartButton.textContent = isStartup ? 'Start Game' : 'Play Again';
            gameOverHighScore.classList.remove('hidden');

            // Reset player visuals
            player.innerHTML = 'üêµ';
            playerX = (boardWidth / 2) - (playerWidth / 2);
            updatePlayerPosition();
        }
        
        function togglePause() { 
            if (gameOver || helpScreen.classList.contains('hidden') === false || settingsScreen.classList.contains('hidden') === false) return; 

            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? 'RESUME' : 'PAUSE';

            if (isPaused) {
                cancelAnimationFrame(gameLoopId);
                clearInterval(enemySpawnId);
                gameLoopId = null;
                enemySpawnId = null;
            } else {
                gameLoopId = requestAnimationFrame(updateGame);
                enemySpawnId = setInterval(spawnEnemy, enemySpawnRate);
            }
        }
        
        function toggleSettings(state) {
            const shouldOpen = (state === 'open' || settingsScreen.classList.contains('hidden'));
            
            if (shouldOpen) {
                 // Only pause if game is running
                 if (gameOver === false && isPaused === false) togglePause(); 
                 
                 gameOverScreen.classList.add('hidden');
                 helpScreen.classList.add('hidden');
                 
                 settingsScreen.classList.remove('hidden');
                 controlTypeSelect.value = controlType; 
                 controlsDiv.style.opacity = '0.5';
                 
                 // Hide in-game buttons when settings is open
                 pauseButton.classList.add('hidden');
                 settingsButton.classList.add('hidden');
            } else {
                settingsScreen.classList.add('hidden');
                setupControls(controlTypeSelect.value); 
                controlsDiv.style.opacity = '1';
                
                if (gameOver) {
                    endGame(true); 
                } else {
                    // Show in-game buttons again and resume
                    pauseButton.classList.remove('hidden');
                    settingsButton.classList.remove('hidden');
                    if (isPaused) togglePause(); 
                }
            }
        }

        // --- Game Logic (Score, Lives, Enemy Spawning, Collision) ---
        
        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = `Score: ${score}`;
        }
        
        function updateLives(change = 0) {
            lives += change;
            livesDisplay.textContent = `Lives: ${'‚ù§Ô∏è'.repeat(lives)}`;
            if (lives <= 0) {
                endGame();
            }
        }
        
        function spawnEnemy() {
            const totalWeight = Object.values(enemyTypes).flat().length;
            const rand = Math.floor(Math.random() * totalWeight);
            let emoji, type, points, speed;

            // Simple weighted random selection
            if (rand < enemyTypes.normal.length * 2) { 
                emoji = enemyTypes.normal[Math.floor(Math.random() * enemyTypes.normal.length)];
                type = 'normal';
                points = 10;
                speed = Math.random() * 1.5 + 1.5; 
            } else if (rand < enemyTypes.normal.length * 2 + enemyTypes.bonus.length) { 
                emoji = enemyTypes.bonus[Math.floor(Math.random() * enemyTypes.bonus.length)];
                type = 'bonus';
                points = emoji === 'ü§ë' ? 50 : 30; 
                speed = Math.random() * 0.5 + 1;
            } else if (rand < enemyTypes.normal.length * 2 + enemyTypes.bonus.length + enemyTypes.negative.length) { 
                emoji = enemyTypes.negative[Math.floor(Math.random() * enemyTypes.negative.length)];
                type = 'negative';
                points = -30;
                speed = Math.random() * 1 + 2; 
            } else { 
                emoji = enemyTypes.powerup[0];
                type = 'powerup';
                points = 0;
                speed = 1; 
            }

            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            enemy.textContent = emoji;
            const x = Math.random() * (boardWidth - enemyHeight);
            
            enemy.style.left = x + 'px';
            enemy.style.top = '-40px'; 
            gameBoard.appendChild(enemy);

            enemies.push({ element: enemy, x: x, y: -40, type: type, points: points, speed: speed });
        }

        function checkCollision() {
            // Check bullet-enemy collisions
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                const bRect = b.element.getBoundingClientRect();
                
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const e = enemies[j];
                    const eRect = e.element.getBoundingClientRect();
                    
                    if (bRect.left < eRect.right && bRect.right > eRect.left &&
                        bRect.top < eRect.bottom && bRect.bottom > eRect.top) {
                        
                        updateScore(e.points);
                        
                        if (e.type === 'powerup') {
                            powerUpTimer = POWERUP_DURATION;
                            player.innerHTML = 'ü¶ç'; 
                        }

                        b.element.remove();
                        bullets.splice(i, 1);
                        e.element.remove();
                        enemies.splice(j, 1);
                        
                        break; 
                    }
                }
            }

            // Check enemy-player collision
            const pRect = player.getBoundingClientRect();
            for (let j = enemies.length - 1; j >= 0; j--) {
                const e = enemies[j];
                const eRect = e.element.getBoundingClientRect();
                
                if (pRect.left < eRect.right && pRect.right > eRect.left &&
                    pRect.top < eRect.bottom && pRect.bottom > eRect.top) {
                    
                    if (e.type === 'normal' || e.type === 'negative') {
                        updateLives(-1); 
                    } else if (e.type === 'powerup') {
                         powerUpTimer = POWERUP_DURATION;
                         player.innerHTML = 'ü¶ç'; 
                    } else {
                        updateScore(e.points);
                    }
                    
                    e.element.remove();
                    enemies.splice(j, 1);
                }
            }
        }
    
        // --- Core Game Loop ---
        
        function updateGame() {
            if (gameOver || isPaused) return; 

            // 1. Handle Player Movement
            if (controlType === 'buttons') {
                handleKeyboardMovement();
            } 
            
            // 2. Handle Bullet Movement
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.y -= bulletSpeed;
                b.element.style.top = b.y + 'px';

                if (b.y < -bulletHeight) {
                    b.element.remove();
                    bullets.splice(i, 1);
                }
            }

            // 3. Handle Enemy Movement and Game Over Check
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                e.y += e.speed;
                e.element.style.top = e.y + 'px';
                
                // Check if enemy passed the bottom
                if (e.y > boardHeight) {
                    if (e.type === 'normal') {
                        updateLives(-1); // Lose a life if a normal enemy passes the bottom
                    }
                    e.element.remove();
                    enemies.splice(i, 1);
                    
                    // Difficulty increase
                    enemySpawnRate = Math.max(500, enemySpawnRate - 5);
                    clearInterval(enemySpawnId);
                    enemySpawnId = setInterval(spawnEnemy, enemySpawnRate);
                }
            }

            // 4. Check for Collisions
            checkCollision();

            gameLoopId = requestAnimationFrame(updateGame);
        }
        
        // --- Touch Control Functions ---

        function handlePointerDown(e) {
             if (gameOver || isPaused || controlType !== 'touch') return;

             const target = e.target;
             if (target === player) {
                 isDragging = true;
                 lastTouchX = e.clientX || e.touches[0].clientX; 
                 e.preventDefault(); 
             }
        }

        function handlePointerMove(e) {
            if (!isDragging || gameOver || isPaused || controlType !== 'touch') return;
            
            const currentTouchX = e.clientX || e.touches[0].clientX;
            const deltaX = currentTouchX - lastTouchX;
            
            playerX += deltaX;
            updatePlayerPosition(); 
            
            lastTouchX = currentTouchX;
            e.preventDefault(); 
        }

        function handlePointerUp() {
            isDragging = false;
        }

        // --- Event Listeners ---
        
        document.addEventListener('keydown', (event) => {
             if (event.key.toLowerCase() === 'p') {
                togglePause();
            }
            
            if (gameOver || isPaused) return; 
            
            keysPressed[event.key] = true;
            if (event.key === ' ') {
                handleShooting(); 
                event.preventDefault(); 
            }
        });

        document.addEventListener('keyup', (event) => {
            if (gameOver || isPaused) return; 
            keysPressed[event.key] = false;
        });

        // Touch Listeners 
        player.addEventListener('pointerdown', handlePointerDown);
        document.addEventListener('pointermove', handlePointerMove);
        document.addEventListener('pointerup', handlePointerUp);

        player.addEventListener('touchstart', handlePointerDown);
        document.addEventListener('touchmove', handlePointerMove);
        player.addEventListener('touchend', handlePointerUp);

        // Button Listeners
        restartButton.addEventListener('click', startGame);
        restartButton.addEventListener('touchstart', (e) => { e.preventDefault(); startGame(); });

        shootButton.addEventListener('click', handleShooting);
        shootButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleShooting(); }); 

        pauseButton.addEventListener('click', togglePause);
        pauseButton.addEventListener('touchstart', (e) => { e.preventDefault(); togglePause(); });

        settingsButton.addEventListener('click', () => toggleSettings('open'));
        settingsButton.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSettings('open'); });
        
        closeSettingsButton.addEventListener('click', () => toggleSettings('close'));
        closeSettingsButton.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSettings('close'); });
        
        openSettingsLink.addEventListener('click', () => toggleSettings('open'));
        openSettingsLink.addEventListener('touchstart', (e) => { e.preventDefault(); toggleSettings('open'); });

        // Help Screen Listeners
        closeHelpButton.addEventListener('click', () => helpScreen.classList.add('hidden'));
        openHelpLink.addEventListener('click', () => helpScreen.classList.remove('hidden'));
        
        document.getElementById('open-help-link').addEventListener('click', () => helpScreen.classList.remove('hidden'));
        document.getElementById('open-help-link').addEventListener('touchstart', (e) => { e.preventDefault(); helpScreen.classList.remove('hidden'); });

        // --- Initialization ---

        function init() {
            loadHighScore();
            controlTypeSelect.value = controlType;
            setupControls(controlType);
            updateScore(0);
            updateLives(0); 
            
            gameOver = true;
            endGame(true); 
        }

        init(); 
    </script>
</body>
</html>
 
